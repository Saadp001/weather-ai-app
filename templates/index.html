<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>

     <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  
</head>

<body>

<div class="container">

    <h1>Weather at a Glance ğŸŒ¥ï¸</h1>

    <!-- Search Form -->
    <form class="search-box" action="/" method="POST">
        <input type="text" name="city" placeholder="Enter city name" required>
        <input type="submit" value="Search">
    </form>

    <!-- Weather Card(left) and ai panel(right) - Shown only after a search -->

    <div class="weather-layout">

        <!-- left side weather card -->
        {% if task %}
        <div class="weather-left">        
            <img class="weather-icon" src="https://openweathermap.org/img/wn/{{ task.icon_ofdb }}@2x.png" alt="icon">    

            <div class="card-content">
                <h2>{{ task.city_ofdb | title   }}</h2>
                <div class="temp">{{ task.temperature_ofdb | int }}Â°C</div>
                <div class="cond">{{ task.condition_ofdb }}</div>
                <p class="extra">Humidity: {{ task.humidity_ofdb }}%</p>
                <p class="extra">Wind: {{ task.wind_ofdb }} m/s</p>
                <p class="extra">Sunrise: {{ task.sunrise_ofdb }}</p>
                <p class="extra">Sunset: {{ task.sunset_ofdb }}</p>
                <div class="date">{{ task.date_created.strftime("%Y-%m-%d") }}</div>
            </div>    
        </div>
        {% endif %}


  <!--   right side ai insights -->
        <div class="weather-right" id="ai-panel">
            <h2>AI Weather Insights</h2>
            <div style="text-align:center;">
                <button id="generate-ai">Generate Insights</button>
            </div>

            <!-- scrollable area that will show the AI result -->
            <div class="ai-content" id="ai-output">
                <!-- insert AI text here; use <ul>/<li> or <p> depending on format -->
                <!-- e.g.
                <ul>
                <li>ğŸŒ¤ï¸ <strong>Weather in Mumbai:</strong> Short sentence...</li>
                <li>ğŸ§­ <strong>Activity Tip:</strong> Short suggestion</li>
                <li>âš ï¸ <strong>Alert:</strong> No major risks today ğŸŒˆ</li>
                </ul>
                -->
            </div>
        </div>


        
    </div>


</div>



<script>
const genBtn = document.getElementById("generate-ai");
const aiOutput = document.getElementById("ai-output");

if (genBtn) {
  genBtn.addEventListener("click", async () => {

    genBtn.disabled = true;
    const original = genBtn.textContent;
    genBtn.textContent = "Generating...";

    const city = "{{ task.city_ofdb }}";
    const temperature = "{{ task.temperature_ofdb }}";
    const condition = "{{ task.condition_ofdb }}";
    const humidity = "{{ task.humidity_ofdb }}";
    const wind = "{{ task.wind_ofdb }}";

    try {
      const res = await fetch("/ai-insights", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ city, temperature, condition, humidity, wind })
      });
      const data = await res.json();
      let txt = data.insights || "";

      // remove markdown bold
      txt = txt.replace(/\*\*/g, "");

      // SPLIT by newline
      const lines = txt.split("\n").map(l => l.trim()).filter(Boolean);

      let html = "";
      html += `<div class="ai-section">`;

      lines.forEach(line => {
        if (line.includes("Weather in")) {
          html += `<h3>ğŸŒ¤ï¸ Weather</h3>`;
        }
        else if (line.toLowerCase().includes("activity")) {
          html += `<h3>ğŸ§­ Activity Tip</h3>`;
        }
        else if (line.toLowerCase().includes("alert")) {
          html += `<h3>âš ï¸ Alert</h3>`;
        }
        else {
          html += `<p class="ai-line">${line}</p>`;
        }
      });

      html += `</div>`;
      aiOutput.innerHTML = html;

      // scroll into view
      document.getElementById("ai-panel")
        .scrollIntoView({ behavior: "smooth", block: "center" });

    } catch (err) {
      aiOutput.innerHTML = "<p>Something went wrong. Try again.</p>";
    } finally {
      genBtn.disabled = false;
      genBtn.textContent = original;
    }
  });
}
</script>



</body>
</html>
